---
title: "Comparison of Covariance Matrix Estimation under Heavy Tails"
author: |
  | Daniel P. Palomar and Rui ZHOU
  | The Hong Kong University of Science and Technology (HKUST)
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
    toc: yes
    toc_depth: 2
  html_document:
    theme: flatly
    highlight: pygments  
    toc: yes
    toc_depth: 2
csl: ieee.csl
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Comparison of Covariance Matrix Estimation under Heavy Tails}
  %\VignetteKeyword{covariance matrix, heavy tails, non Gaussian}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "85%",
  dpi = 96,
  pngquant = "--speed=1"
)
knitr_in_progress <- isTRUE(getOption('knitr.in.progress'))
knit_hooks$set(pngquant = hook_pngquant)
# rmarkdown::render("vignettes/fitHeavyTail.Rmd", "prettydoc::html_pretty")
```

-----------
> This vignette illustrates the usage of the package [`fitHeavyTail`](https://github.com/dppalomar/fitHeavyTail) 
to estimate covariance matrices for heavy-tailed distributions and compares with existing benchmark functions from different packages.


# Installation
The package can be installed from [CRAN](https://CRAN.R-project.org/package=fitHeavyTail) or [GitHub](https://github.com/dppalomar/fitHeavyTail):
```{r, eval=FALSE}
# install stable version from CRAN
install.packages("fitHeavyTail")

# install development version from GitHub
devtools::install_github("dppalomar/fitHeavyTail")

# Getting help
library(fitHeavyTail)
help(package = "fitHeavyTail")
?fit_mvt
```


# Usage


# Numerical Comparison with Existing Benchmarks


```{r}
library(mvtnorm)
library(fitHeavyTail)
library(ggplot2)
library(reshape2)

# Comparison with other packages:
#   EstimateMoments_MinskerWei(X) is not good...
#   rrcov::

N <- 20
nu <- 4
mu <- rep(0, N)

set.seed(123)
U <- t(rmvnorm(n = round(1.1*N), sigma = 0.1*diag(N)))
Sigma <- U %*% t(U) + diag(N)
Sigma_scale <- (nu-2)/nu * Sigma
qplot(eigen(Sigma)$values, geom = "histogram", xlab = "eigenvalues", fill = I("cyan"), col = I("black"),
      main = "Histogram of eigenvalues of true covariance matrix")
```

```{r, fig.width = 9, fig.height = 5, out.width = "100%", message = FALSE}
MSE <- function(est_cov) norm(est_cov - Sigma, "F")^2
eval_single <- function(X) {
  errors <- times <- c()
  
  name         <- "SCM"
  times[name]  <- system.time({Sigma_est <- cov(X)})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Tyler"
  times[name]  <- system.time({Sigma_est <- momentsTyler(X)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Cauchy"
  times[name]  <- system.time({Sigma_est <- momentsCauchy(X)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Student's t"
  times[name]  <- system.time({Sigma_est <- fit_mvt(X)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Student's t (nu = 6)"
  times[name]  <- system.time({Sigma_est <- fit_mvt(X, nu = 6)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Student's t (nu from kurtosis)"
  times[name]  <- system.time({Sigma_est <- fit_mvt(X, nu = "kurtosis")$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Student's t (nu_target = 6)"
  times[name]  <- system.time({Sigma_est <- fit_mvt(X, nu_target = 6, nu_regcoef = 1)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "Student's t (nu_target from kurtosis)"
  times[name]  <- system.time({Sigma_est <- fit_mvt(X, nu_target = NULL, nu_regcoef = 1)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "QRM::fit.mst"
  times[name]  <- system.time({Sigma_est <- tryCatch(as.matrix(QRM::fit.mst(X, method = "BFGS", nit = 100, tol = 1e-6)$covariance),
                                                     warning = function(w) return(NA), error   = function(e) return(NA))})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "MASS::cov.trov (nu=6)"
  times[name]  <- system.time({Sigma_est <- MASS::cov.trob(X, nu = 6)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "MASS::cov.mve"
  times[name]  <- system.time({Sigma_est <- MASS::cov.mve(X)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "robustbase::covMcd"
  times[name]  <- system.time({Sigma_est <- suppressWarnings(robustbase::covMcd(X)$cov)})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "robust::covRob"
  times[name]  <- system.time({Sigma_robust_covRob <- tryCatch(robust::covRob(X, estim = "pairwiseQC")$cov,  
                                                               warning = function(w) return(NA), error   = function(e) return(NA))})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  name         <- "covRobust::cov.nnve"
  times[name]  <- system.time({Sigma_est <- covRobust::cov.nnve(X)$cov})["elapsed"]
  errors[name] <- MSE(Sigma_est)
  
  return(list("MSE" = errors, "time" = times))
}

N_realiz <- 100  # multiple realizations for averaging
T_sweep <- round(seq(from = ceiling(1.5*N), to = 5*N, length.out = 12))

if (!knitr_in_progress) pbar <- txtProgressBar(min = it<-0, max = length(T_sweep), style=3)
MSE_all_T <- time_all_T <- NULL
for(T in T_sweep) {
  if (!knitr_in_progress) setTxtProgressBar(pbar, it<-it+1)
  res <- lapply(1:N_realiz, function(idx) {
    X <- rmvt(n = T, delta = mu, sigma = Sigma_scale, df = nu)
    eval_single(X)
  })
  MSE_all_T  <- rbind(MSE_all_T,  apply(sapply(res, function(x) x$MSE),  1, mean))
  time_all_T <- rbind(time_all_T, apply(sapply(res, function(x) x$time), 1, mean))
}


# MSE plots
rownames(MSE_all_T) <- T_sweep
ggplot(melt(MSE_all_T), aes(x = Var1, y = value, col = Var2, shape = Var2)) +
  geom_line() + geom_point() + coord_cartesian(ylim = c(0, 500)) +
  theme(legend.title = element_blank()) +
  ggtitle(bquote("MSE of covariance matrix estimation for heavy-tailed data (" * N == .(N) * "," ~ nu == .(nu)* ")")) +
  xlab("T") + ylab("MSE")
# ggtitle(latex2exp::TeX(sprintf("MSE of covariance matrix estimation for heavy-tailed data (N = %d, $\\nu$ = %.2f)", N, nu))) +
# check here is TeX problem has been fixed: https://github.com/stefano-meschiari/latex2exp/pull/21


# time plots
rownames(time_all_T) <- T_sweep
time_all_T[is.na(MSE_all_T)] <- NA
ggplot(melt(time_all_T), aes(x = Var1, y = value, col = Var2, shape = Var2)) +
  geom_line() + geom_point() +
  theme(legend.title = element_blank()) +
  ggtitle(bquote("Computational cost of the computation of covariance matrices for heavy-tailed data (" * N == .(N) * "," ~ nu == .(nu)* ")")) +
  xlab("T") + ylab("cpu time")

```

Observations:

TODO:



# Algorithm Description
The algorithms used in the package are based on the paper [@ZhouLiuKumarPalomar2019].

TBD



# References {-}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent
