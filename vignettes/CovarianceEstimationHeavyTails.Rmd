---
title: "Comparison of Covariance Matrix Estimation under Heavy Tails"
author: |
  | Daniel P. Palomar and Rui ZHOU
  | The Hong Kong University of Science and Technology (HKUST)
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
    toc: yes
    toc_depth: 2
  html_document:
    theme: flatly
    highlight: pygments  
    toc: yes
    toc_depth: 2
csl: ieee.csl
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Comparison of Covariance Matrix Estimation under Heavy Tails}
  %\VignetteKeyword{covariance matrix, heavy tails, non Gaussian}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "85%",
  dpi = 96,
  pngquant = "--speed=1"
)
knit_hooks$set(pngquant = hook_pngquant)
# rmarkdown::render("vignettes/CovarianceEstimationHeavyTails.Rmd", "prettydoc::html_pretty")
```

-----------
> This vignette illustrates the usage of the package [`fitHeavyTail`](https://github.com/dppalomar/fitHeavyTail) 
to estimate covariance matrices for heavy-tailed distributions and compares with existing benchmark functions from different packages.


# Comparison with existing benchmark functions

```{r}
library(mvtnorm)
library(covHeavyTail)
library(ggplot2)
library(reshape2)

#
# Test of different packages for estimation of mu and R under heavy tails
#
# Comparison with other packages:
#   MASS::cov.rob(X, method="mcd" or "mve")$cov: it's very slow and the performance not good
#   robustbase::covMcd(X)$cov is slow and not good performance
#   robust::covRob(X)$cov does not perform well
#   covRobust::cov.nnve(X)[c("mu","cov")] does not perform well and it's kind of slow
#   EstimateMoments_MinskerWei(X) is not good...
#   [covHeavyTail or FinCovMat]
#

N <- 20
nu <- 4
mu <- rep(0, N)

set.seed(357)
U <- t(rmvnorm(n = round(1.1*N), sigma = 0.1*diag(N)))
Sigma <- U %*% t(U) + diag(N)
Sigma_scale <- (nu-2)/nu * Sigma
qplot(eigen(Sigma)$values, geom = "histogram", xlab = "eigenvalues", fill = I("cyan"), col = I("black"),
      main = "Histogram of eigenvalues of true covariance matrix")
```

```{r, fig.width = 9, fig.height = 5, out.width = "100%"}
N_realiz <- 10  # multiple realizations for averaging
T_sweep <- round(seq(from = ceiling(1.5*N), to = 5*N, length.out = 12))
MSE_MASS_cov.trov_T <- MSE_QRM_T <- MSE_Studentt_T <- MSE_Studentt_nu_T <- MSE_Cauchy_T <- MSE_Tyler_T <- MSE_SCM_T <- NULL
time_MASS_cov.trov_T <- time_QRM_T <- time_Studentt_T <- time_Studentt_nu_T <- time_Cauchy_T <- time_Tyler_T <- time_SCM_T <- NULL
if (interactive()) pbar <- txtProgressBar(min = it<-0, max = length(T_sweep), style=3)
for(T in T_sweep) {
  if (interactive()) setTxtProgressBar(pbar, it<-it+1)
  MSE_MASS_cov.trov <- MSE_QRM <- MSE_Studentt <- MSE_Studentt_nu <- MSE_Cauchy <- MSE_Tyler <- MSE_SCM <- 0
  time_MASS_cov.trov <- time_QRM <- time_Studentt <- time_Studentt_nu <- time_Cauchy <- time_Tyler <- time_SCM <- 0
  for (ii in 1:N_realiz) {
    # generate data
    X <- rmvt(n = T, delta = mu, sigma = Sigma_scale, df = nu)  # heavy-tailed data
    #X <- rmvnorm(n = T, mean = mu, sigma = Sigma)  # Gaussian data


    # Sigma estimation
    time_SCM <- time_SCM + system.time({
      Sigma_SCM <- cov(X)
    })["elapsed"]

    time_Tyler <- time_Tyler + system.time({
      Sigma_Tyler <- momentsTyler(X)$cov
    })["elapsed"]

    time_Cauchy <- time_Cauchy + system.time({
      Sigma_Cauchy <- momentsCauchy(X)$cov
    })["elapsed"]

    time_Studentt_nu <- time_Studentt_nu + system.time({
      Sigma_Studentt_nu <- momentsStudentt(X, nu = 6)$cov
    })["elapsed"]

    time_Studentt <- time_Studentt + system.time({
      Sigma_Studentt <- momentsStudentt(X)$cov
    })["elapsed"]

    time_QRM <- time_QRM + system.time({
      Sigma_QRM <- tryCatch(
        as.matrix(QRM::fit.mst(X, method = "BFGS", nit = 100, tol = 1e-6)$covariance),
        warning = function(w) return(NA),
        error   = function(e) return(NA))
    })["elapsed"]

    time_MASS_cov.trov <- time_MASS_cov.trov + system.time({
      Sigma_MASS_cov.trov <- MASS::cov.trob(X, nu = 6)$cov
    })["elapsed"]





    # compute MSEs
    MSE_SCM <- MSE_SCM + norm(Sigma_SCM - Sigma, "F")^2
    MSE_Tyler <- MSE_Tyler + norm(Sigma_Tyler - Sigma, "F")^2
    MSE_Cauchy <- MSE_Cauchy + norm(Sigma_Cauchy - Sigma, "F")^2
    MSE_Studentt_nu <- MSE_Studentt_nu + norm(Sigma_Studentt_nu - Sigma, "F")^2
    MSE_Studentt <- MSE_Studentt + norm(Sigma_Studentt - Sigma, "F")^2
    MSE_QRM  <- MSE_QRM  + norm(Sigma_QRM - Sigma, "F")^2
    MSE_MASS_cov.trov  <- MSE_MASS_cov.trov  + norm(Sigma_MASS_cov.trov - Sigma, "F")^2
  }
  # keep track of MSEs
  MSE_SCM_T  <- c(MSE_SCM_T, MSE_SCM / N_realiz)
  MSE_Tyler_T <- c(MSE_Tyler_T, MSE_Tyler / N_realiz)
  MSE_Cauchy_T <- c(MSE_Cauchy_T, MSE_Cauchy / N_realiz)
  MSE_Studentt_nu_T <- c(MSE_Studentt_nu_T, MSE_Studentt_nu / N_realiz)
  MSE_Studentt_T <- c(MSE_Studentt_T, MSE_Studentt / N_realiz)
  MSE_QRM_T <- c(MSE_QRM_T, MSE_QRM / N_realiz)
  MSE_MASS_cov.trov_T <- c(MSE_MASS_cov.trov_T, MSE_MASS_cov.trov / N_realiz)
  # keep track of MSEs
  time_SCM_T <- c(time_SCM_T, time_SCM / N_realiz)
  time_Tyler_T <- c(time_Tyler_T, time_Tyler / N_realiz)
  time_Cauchy_T <- c(time_Cauchy_T, time_Cauchy / N_realiz)
  time_Studentt_nu_T <- c(time_Studentt_nu_T, time_Studentt_nu / N_realiz)
  time_Studentt_T <- c(time_Studentt_T, time_Studentt / N_realiz)
  time_QRM_T <- c(time_QRM_T, time_QRM / N_realiz)
  time_MASS_cov.trov_T <- c(time_MASS_cov.trov_T, time_MASS_cov.trov / N_realiz)
}


# MSE plots
MSE_all_T <- cbind("SCM"                   = MSE_SCM_T,
                   "Tyler"                 = MSE_Tyler_T,
                   "Cauchy"                = MSE_Cauchy_T,
                   "Student-t (nu=6)"      = MSE_Studentt_nu_T,
                   "Student-t"             = MSE_Studentt_T,
                   "QRM::fit.mst"          = MSE_QRM_T,
                   "MASS::cov.trov (nu=6)" = MSE_MASS_cov.trov_T)
rownames(MSE_all_T) <- T_sweep
ggplot(melt(MSE_all_T), aes(x = Var1, y = value, col = Var2, shape = Var2)) +
  geom_line() + geom_point() + coord_cartesian(ylim = c(0, 500)) +
  theme(legend.title = element_blank()) +
  ggtitle(bquote("MSE of covariance matrix estimation for heavy-tailed data (" * N == .(N) * "," ~ nu == .(nu)* ")")) +
  xlab("T") + ylab("MSE")
# ggtitle(latex2exp::TeX(sprintf("MSE of covariance matrix estimation for heavy-tailed data (N = %d, $\\nu$ = %.2f)", N, nu))) +
# check here is TeX problem has been fixed: https://github.com/stefano-meschiari/latex2exp/pull/21


# time plots
time_all_T <- cbind("SCM"                   = time_SCM_T,
                    "Tyler"                 = time_Tyler_T,
                    "Cauchy"                = time_Cauchy_T,
                    "Student-t (nu=6)"      = time_Studentt_nu_T,
                    "Student-t"             = time_Studentt_T,
                    "QRM::fit.mst"          = time_QRM_T,
                    "MASS::cov.trov (nu=6)" = time_MASS_cov.trov_T)
rownames(time_all_T) <- T_sweep
time_all_T[is.na(MSE_all_T)] <- NA
ggplot(melt(time_all_T), aes(x = Var1, y = value, col = Var2, shape = Var2)) +
  geom_line() + geom_point() +
  theme(legend.title = element_blank()) +
  ggtitle(bquote("Computational cost of the computation of covariance matrices for heavy-tailed data (" * N == .(N) * "," ~ nu == .(nu)* ")")) +
  xlab("T") + ylab("cpu time")

```

Observations:

- `QRM::fit.mst()` has similar performance to our `fit_mvt()` (except that it fails with few observations), but the computational complexity is unnacceptably high. It's not an option in practice.
- `MASS::cov.trov(nu=6)` has similar or slighlty worse performance than our `fit_mvt(nu=6)`, with similar compulational complexity.

