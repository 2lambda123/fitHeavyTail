---
title: "Comparison of Covariance Matrix Estimation under Heavy Tails"
author: |
  | Daniel P. Palomar and Rui ZHOU
  | The Hong Kong University of Science and Technology (HKUST)
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
    toc: yes
    toc_depth: 2
  html_document:
    theme: flatly
    highlight: pygments  
    toc: yes
    toc_depth: 2
csl: ieee.csl
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Comparison of Covariance Matrix Estimation under Heavy Tails}
  %\VignetteKeyword{covariance matrix, heavy tails, non Gaussian}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "85%",
  dpi = 96,
  pngquant = "--speed=1"
)
knitr_in_progress <- isTRUE(getOption('knitr.in.progress'))
knit_hooks$set(pngquant = hook_pngquant)
# rmarkdown::render("vignettes/CovarianceEstimationHeavyTails.Rmd", "prettydoc::html_pretty")
```

-----------
> This vignette illustrates the usage of the package [`portfolioBacktest`](https://CRAN.R-project.org/package=fitHeavyTail) 
to estimate the mean vector and covariance matrix of a multivariate heavy-tailed Student's $t$ distribution, and compares it
with existing benchmark functions from different packages.
    

# Installation
The package can be installed from [CRAN](https://CRAN.R-project.org/package=fitHeavyTail) or [GitHub](https://github.com/dppalomar/fitHeavyTail):
```{r, eval=FALSE}
# install stable version from CRAN
install.packages("fitHeavyTail")

# install development version from GitHub
devtools::install_github("dppalomar/fitHeavyTail")

# Getting help
library(fitHeavyTail)
help(package = "fitHeavyTail")
?fit_mvt
```



# Quick Start
To illustrate the simple usage of the package `fitHeavyTail`, let's start by generating some multivariate data under a Student's $t$ distribution with significant heavy tails ($\nu=4$):
```{r}
library(mvtnorm)
N <- 10
T <- 80
nu <- 4

set.seed(42)
mu <- rep(0, N)
U <- t(rmvnorm(n = round(0.3*N), sigma = 0.1*diag(N)))
Sigma <- U %*% t(U) + diag(N)
Sigma_scatter <- (nu-2)/nu * Sigma
X <- rmvt(n = T, delta = mu, sigma = Sigma_scatter, df = nu)  # heavy-tailed data
```

We can first estimate the mean vector and covariance matrix via the traditional sample estimates (i.e., sample mean and sample covariance matrix):
```{r}
mu_sm <- colMeans(X)
Sigma_scm <- cov(X)
```

Then we can compute the robust estimates via the package `fitHeavyTail`:
```{r}
library(fitHeavyTail)
fitted <- fit_mvt(X)
```

We can now compute the estimation errors:
```{r}
sum((mu_sm - mu)^2)
sum((fitted$mu - mu)^2)

sum((Sigma_scm - Sigma)^2)
sum((fitted$cov - Sigma)^2)
```

To get a visual idea of the robustness, we can plot the shapes of the covariance matrices (true and estimated) projected on two dimensions:
```{r, eval=FALSE}
library(ellipse)

i1 <- 7  #7-4, 7-5
i2 <- 5
# for (i1 in 1:N)
#   for (i2 in 1:N) {
# print(i1); print(i2)
plot(X[, i1], X[, i2], 
     main = "Scatter plot of Gaussian returns", xlab = "asset 1", ylab = "asset 2",
     col = rgb(0, 100, 0, 100, maxColorValue = 255), pch = 16)
lines(ellipse(Sigma[c(i1, i2), c(i1, i2)]), col = "black", lwd = 2)
lines(ellipse(Sigma_scm[c(i1, i2), c(i1, i2)], centre = mu_sm[c(i1, i2)]), col = "red", lwd = 2)
lines(ellipse(fitted$cov[c(i1, i2), c(i1, i2)], centre = fitted$mu[c(i1, i2)]), col = "blue", lwd = 2)
# readline()
# }
```


```{r}
library(ggplot2)
library(ellipse)

i1 <- 7; i2 <- 5
ggplot(data.frame(x = X[, i1], y = X[, i2]), aes(x, y)) +
  geom_point(alpha = 0.7, size = 3) +
  geom_path(data = data.frame(ellipse(Sigma[c(i1, i2), c(i1, i2)])), aes(x, y), col = "black", lwd = 1) +
  geom_path(data = data.frame(ellipse(Sigma_scm[c(i1, i2), c(i1, i2)], centre = mu_sm[c(i1, i2)])), aes(x, y), col = "red", lwd = 1) +
  geom_path(data = data.frame(ellipse(fitted$cov[c(i1, i2), c(i1, i2)], centre = fitted$mu[c(i1, i2)])), aes(x, y), col = "blue", lwd = 1) +
  ggtitle("Data points and shapes of covariance matrices")


# ggplot(data.frame(x = X[, i1], y = X[, i2]), aes(x, y)) +
#   geom_point(alpha = 0.7, size = 3) +
#   geom_path(data = data.frame(ellipse(Sigma[c(i1, i2), c(i1, i2)])), aes(x, y, col = "black"), lwd = 1) +
#   geom_path(data = data.frame(ellipse(Sigma_scm[c(i1, i2), c(i1, i2)], centre = mu_sm[c(i1, i2)])), aes(x, y, col = "red"), lwd = 1) +
#   geom_path(data = data.frame(ellipse(fitted$cov[c(i1, i2), c(i1, i2)], centre = fitted$mu[c(i1, i2)])), aes(x, y, col = "blue"), lwd = 1) +
#   ggtitle("Data points and shapes of covariance matrices")

# ggplot(df, aes(x = instance, y = total_hits))+geom_point(size = 1)+geom_line()+
# geom_line(aes(x=instance, y = line1, colour="myline1")) +
# geom_vline(xintercept=805)+geom_line(aes(x=df$instance, y = line2, colour="myline2"))+
# geom_line(aes(x=instance, y = line3, colour="myline3")) +
# scale_colour_manual(name="Line Color",
#     values=c(myline1="red", myline2="blue", myline3="purple"))
```






# Numerical Comparison with Existing Packages
```{r}
library(mvtnorm)
library(fitHeavyTail)
library(ggplot2)
library(reshape2)

N <- 20
nu <- 4
mu <- rep(0, N)

set.seed(357)
U <- t(rmvnorm(n = round(0.3*N), sigma = 0.1*diag(N)))
Sigma <- U %*% t(U) + diag(N)
Sigma_scatter <- (nu-2)/nu * Sigma
qplot(eigen(Sigma)$values, geom = "histogram", xlab = "eigenvalues", fill = I("cyan"), col = I("black"),
      main = "Histogram of eigenvalues of true covariance matrix")
```

```{r, fig.width = 9, fig.height = 5, out.width = "100%"}
N_realiz <- 20  # multiple realizations for averaging
T_sweep <- round(seq(from = ceiling(1.5*N), to = 5*N, length.out = 12))
MSE_rrcov_CovMrcd_T <- MSE_covRobust_cov.nnve_T <- MSE_robust_covRob_T <- MSE_robustbase_covMcd_T <- 
  MSE_MASS_cov.mve_T <- MSE_MASS_cov.trov_T <- MSE_QRM_fit.mst_T <- 
  MSE_fitHeavyTail_Studentt_T <- MSE_fitHeavyTail_Studentt_nu_T <- MSE_fitHeavyTail_Cauchy_T <- MSE_fitHeavyTail_Tyler_T <- MSE_SCM_T <- NULL
time_rrcov_CovMrcd_T <- time_covRobust_cov.nnve_T <- time_robust_covRob_T <- time_robustbase_covMcd_T <- 
  time_MASS_cov.mve_T <- time_MASS_cov.trov_T <- time_QRM_fit.mst_T <- 
  time_fitHeavyTail_Studentt_T <- time_fitHeavyTail_Studentt_nu_T <- time_fitHeavyTail_Cauchy_T <- time_fitHeavyTail_Tyler_T <- time_SCM_T <- NULL
if (!knitr_in_progress) pbar <- txtProgressBar(min = it<-0, max = length(T_sweep), style=3)
for(T in T_sweep) {
  if (!knitr_in_progress) setTxtProgressBar(pbar, it<-it+1)
  MSE_rrcov_CovMrcd <- MSE_covRobust_cov.nnve <- MSE_robust_covRob <- MSE_robustbase_covMcd <- 
    MSE_MASS_cov.mve <- MSE_MASS_cov.trov <- MSE_QRM_fit.mst <- 
    MSE_fitHeavyTail_Studentt <- MSE_fitHeavyTail_Studentt_nu <- MSE_fitHeavyTail_Cauchy <- MSE_fitHeavyTail_Tyler <- MSE_SCM <- 0
  time_rrcov_CovMrcd <- time_covRobust_cov.nnve <- time_robust_covRob <- time_robustbase_covMcd <- 
    time_MASS_cov.mve <- time_MASS_cov.trov <- time_QRM_fit.mst <- 
    time_fitHeavyTail_Studentt <- time_fitHeavyTail_Studentt_nu <- time_fitHeavyTail_Cauchy <- time_fitHeavyTail_Tyler <- time_SCM <- 0
  for (ii in 1:N_realiz) {
    # generate data
    X <- rmvt(n = T, delta = mu, sigma = Sigma_scatter, df = nu)  # heavy-tailed data
    #X <- rmvnorm(n = T, mean = mu, sigma = Sigma)  # Gaussian data


    # Sigma estimation
    time_SCM <- time_SCM + system.time({
      Sigma_SCM <- cov(X)
    })["elapsed"]

    time_fitHeavyTail_Tyler <- time_fitHeavyTail_Tyler + system.time({
      Sigma_fitHeavyTail_Tyler <- fitHeavyTail:::momentsTyler(X)$cov
    })["elapsed"]

    time_fitHeavyTail_Cauchy <- time_fitHeavyTail_Cauchy + system.time({
      Sigma_fitHeavyTail_Cauchy <- fitHeavyTail:::momentsCauchy(X)$cov
    })["elapsed"]

    time_fitHeavyTail_Studentt_nu <- time_fitHeavyTail_Studentt_nu + system.time({
      Sigma_fitHeavyTail_Studentt_nu <- fit_mvt(X, nu = 6)$cov
      # res <- fit_mvt(X, nu = 6, ftol = 1e6, return_iterates = TRUE)
      # plot(sapply(res$iterations_record, `[[`, "nu"))
      # plot(sapply(res$iterations_record, `[[`, "log_likelihood"))
    })["elapsed"]

    time_fitHeavyTail_Studentt <- time_fitHeavyTail_Studentt + system.time({
      Sigma_fitHeavyTail_Studentt <- fit_mvt(X, nu_regcoef = 1e0, verbose = FALSE)$cov
      # res <- fit_mvt(X, ftol = 1e6, return_iterates = TRUE)
      # plot(sapply(res$iterations_record, `[[`, "nu"))
      # plot(sapply(res$iterations_record, `[[`, "log_likelihood"))
    })["elapsed"]

    time_QRM_fit.mst <- time_QRM_fit.mst + system.time({
      Sigma_QRM_fit.mst <- tryCatch(
        as.matrix(QRM::fit.mst(X, method = "BFGS", nit = 100, tol = 1e-6)$covariance),
        warning = function(w) return(NA),
        error   = function(e) return(NA))
    })["elapsed"]

    time_MASS_cov.trov <- time_MASS_cov.trov + system.time({
      Sigma_MASS_cov.trov <- MASS::cov.trob(X, nu = 6)$cov
    })["elapsed"]
    
    time_MASS_cov.mve <- time_MASS_cov.mve + system.time({
      Sigma_MASS_cov.mve <- MASS::cov.mve(X)$cov
    })["elapsed"]

    time_robustbase_covMcd <- time_robustbase_covMcd + system.time({
      Sigma_robustbase_covMcd <- suppressWarnings(robustbase::covMcd(X)$cov)
    })["elapsed"]
    
    time_robust_covRob <- time_robust_covRob + system.time({
      Sigma_robust_covRob <- tryCatch(
        robust::covRob(X, estim = "pairwiseQC")$cov,  # "pairwiseQC", also: "weighted", "M", "pairwiseGK"
        warning = function(w) return(NA),
        error   = function(e) return(NA))
    })["elapsed"]
    
    time_covRobust_cov.nnve <- time_covRobust_cov.nnve + system.time({
      Sigma_covRobust_cov.nnve <- covRobust::cov.nnve(X)$cov
    })["elapsed"]

    time_rrcov_CovMrcd <- time_rrcov_CovMrcd + system.time({
      Sigma_rrcov_CovMrcd <- rrcov::CovMrcd(X)$cov
    })["elapsed"]
        
    

    # compute MSEs
    MSE_SCM                      <- MSE_SCM                      + norm(Sigma_SCM - Sigma, "F")^2
    MSE_fitHeavyTail_Tyler       <- MSE_fitHeavyTail_Tyler       + norm(Sigma_Tyler - Sigma, "F")^2
    MSE_fitHeavyTail_Cauchy      <- MSE_fitHeavyTail_Cauchy      + norm(Sigma_fitHeavyTail_Cauchy - Sigma, "F")^2
    MSE_fitHeavyTail_Studentt_nu <- MSE_fitHeavyTail_Studentt_nu + norm(Sigma_fitHeavyTail_Studentt_nu - Sigma, "F")^2
    MSE_fitHeavyTail_Studentt    <- MSE_fitHeavyTail_Studentt    + norm(Sigma_fitHeavyTail_Studentt - Sigma, "F")^2
    MSE_QRM_fit.mst              <- MSE_QRM_fit.mst              + norm(Sigma_QRM_fit.mst - Sigma, "F")^2
    MSE_MASS_cov.trov            <- MSE_MASS_cov.trov            + norm(Sigma_MASS_cov.trov - Sigma, "F")^2
    MSE_MASS_cov.mve             <- MSE_MASS_cov.mve             + norm(Sigma_MASS_cov.mve - Sigma, "F")^2
    MSE_robustbase_covMcd        <- MSE_robustbase_covMcd        + norm(Sigma_robustbase_covMcd - Sigma, "F")^2
    MSE_robust_covRob            <- MSE_robust_covRob            + norm(Sigma_robust_covRob - Sigma, "F")^2
    MSE_covRobust_cov.nnve       <- MSE_covRobust_cov.nnve       + norm(Sigma_covRobust_cov.nnve  - Sigma, "F")^2
    MSE_rrcov_CovMrcd            <- MSE_rrcov_CovMrcd            + norm(Sigma_rrcov_CovMrcd  - Sigma, "F")^2
  }
  # keep track of MSEs
  MSE_SCM_T                      <- c(MSE_SCM_T,                      MSE_SCM / N_realiz)
  MSE_fitHeavyTail_Tyler_T       <- c(MSE_fitHeavyTail_Tyler_T,       MSE_fitHeavyTail_Tyler / N_realiz)
  MSE_fitHeavyTail_Cauchy_T      <- c(MSE_fitHeavyTail_Cauchy_T,      MSE_fitHeavyTail_Cauchy / N_realiz)
  MSE_fitHeavyTail_Studentt_nu_T <- c(MSE_fitHeavyTail_Studentt_nu_T, MSE_fitHeavyTail_Studentt_nu / N_realiz)
  MSE_fitHeavyTail_Studentt_T    <- c(MSE_fitHeavyTail_Studentt_T,    MSE_fitHeavyTail_Studentt / N_realiz)
  MSE_QRM_fit.mst_T              <- c(MSE_QRM_fit.mst_T,              MSE_QRM_fit.mst / N_realiz)
  MSE_MASS_cov.trov_T            <- c(MSE_MASS_cov.trov_T,            MSE_MASS_cov.trov / N_realiz)
  MSE_MASS_cov.mve_T             <- c(MSE_MASS_cov.mve_T,             MSE_MASS_cov.mve / N_realiz)
  MSE_robustbase_covMcd_T        <- c(MSE_robustbase_covMcd_T,        MSE_robustbase_covMcd / N_realiz)
  MSE_robust_covRob_T            <- c(MSE_robust_covRob_T,            MSE_robust_covRob / N_realiz)
  MSE_covRobust_cov.nnve_T       <- c(MSE_covRobust_cov.nnve_T,       MSE_covRobust_cov.nnve / N_realiz)
  MSE_rrcov_CovMrcd_T            <- c(MSE_rrcov_CovMrcd_T,            MSE_rrcov_CovMrcd / N_realiz)
  
  # keep track of times
  time_SCM_T                      <- c(time_SCM_T,                      time_SCM / N_realiz)
  time_fitHeavyTail_Tyler_T       <- c(time_fitHeavyTail_Tyler_T,       time_fitHeavyTail_Tyler / N_realiz)
  time_fitHeavyTail_Cauchy_T      <- c(time_fitHeavyTail_Cauchy_T,      time_fitHeavyTail_Cauchy/ N_realiz)
  time_fitHeavyTail_Studentt_nu_T <- c(time_fitHeavyTail_Studentt_nu_T, time_fitHeavyTail_Studentt_nu / N_realiz)
  time_fitHeavyTail_Studentt_T    <- c(time_fitHeavyTail_Studentt_T,    time_fitHeavyTail_Studentt / N_realiz)
  time_QRM_fit.mst_T              <- c(time_QRM_fit.mst_T,              time_QRM_fit.mst / N_realiz)
  time_MASS_cov.trov_T            <- c(time_MASS_cov.trov_T,            time_MASS_cov.trov / N_realiz)
  time_MASS_cov.mve_T             <- c(time_MASS_cov.mve_T,             time_MASS_cov.mve / N_realiz)
  time_robustbase_covMcd_T        <- c(time_robustbase_covMcd_T,        time_robustbase_covMcd / N_realiz)
  time_robust_covRob_T            <- c(time_robust_covRob_T,            time_robust_covRob / N_realiz)
  time_covRobust_cov.nnve_T       <- c(time_covRobust_cov.nnve_T,       time_covRobust_cov.nnve / N_realiz)
  time_rrcov_CovMrcd_T            <- c(time_rrcov_CovMrcd_T,            time_rrcov_CovMrcd / N_realiz)
}


# MSE plots
MSE_all_T <- cbind("SCM"                          = MSE_SCM_T,
                   #"fitHeavyTail::Tyler"          = MSE_fitHeavyTail_Tyler_T,
                   #"fitHeavyTail::Cauchy"         = MSE_fitHeavyTail_Cauchy_T,
                   "QRM::fit.mst"                 = MSE_QRM_fit.mst_T,
                   "MASS::cov.trov (nu=6)"        = MSE_MASS_cov.trov_T,
                   "MASS::cov.mve"                = MSE_MASS_cov.mve_T,
                   "robustbase::covMcd"           = MSE_robustbase_covMcd_T,
                   "robust::covRob"               = MSE_robust_covRob_T,
                   "covRobust::cov.nnve"          = MSE_covRobust_cov.nnve_T,
                   "fitHeavyTail::fit_mvt (nu=6)" = MSE_fitHeavyTail_Studentt_nu_T,
                   "fitHeavyTail::fit_mvt"        = MSE_fitHeavyTail_Studentt_T)
rownames(MSE_all_T) <- T_sweep
ggplot(melt(MSE_all_T), aes(x = Var1, y = value, col = Var2, shape = Var2)) +
  geom_line() + geom_point(size = 2) + scale_y_log10() + #coord_cartesian(ylim = c(0, 500)) +
  scale_shape_manual(values = 1:9) +
  theme(legend.title = element_blank()) +
  ggtitle(bquote("MSE of covariance matrix estimation for heavy-tailed data (" * N == .(N) * "," ~ nu == .(nu)* ")")) +
  xlab("T") + ylab("MSE")
# ggtitle(latex2exp::TeX(sprintf("MSE of covariance matrix estimation for heavy-tailed data (N = %d, $\\nu$ = %.2f)", N, nu))) +
# check here is TeX problem has been fixed: https://github.com/stefano-meschiari/latex2exp/pull/21


# time plots
time_all_T <- cbind("SCM"                          = time_SCM_T,
                    #"fitHeavyTail::Tyler"          = time_fitHeavyTail_Tyler_T,
                    #"fitHeavyTail::Cauchy"         = time_fitHeavyTail_Cauchy_T,
                    "QRM::fit.mst"                 = time_QRM_fit.mst_T,
                    "MASS::cov.trov (nu=6)"        = time_MASS_cov.trov_T,
                    "MASS::cov.mve"                = time_MASS_cov.mve_T,
                    "robustbase::covMcd"           = time_robustbase_covMcd_T,
                    "robust::covRob"               = time_robust_covRob_T,
                    "covRobust::cov.nnve"          = time_covRobust_cov.nnve_T,
                    "fitHeavyTail::fit_mvt (nu=6)" = time_fitHeavyTail_Studentt_nu_T,
                    "fitHeavyTail::fit_mvt"        = time_fitHeavyTail_Studentt_T)
rownames(time_all_T) <- T_sweep
time_all_T[is.na(MSE_all_T)] <- NA
ggplot(melt(time_all_T), aes(x = Var1, y = value, col = Var2, shape = Var2)) +
  geom_line() + geom_point() + scale_y_log10() +
  scale_shape_manual(values = 1:9) +
  theme(legend.title = element_blank()) +
  ggtitle(bquote("Computational cost of the computation of covariance matrices for heavy-tailed data (" * N == .(N) * "," ~ nu == .(nu)* ")")) +
  xlab("T") + ylab("cpu time")
```

Observations:

- our `fit_mvt()` seems to be the best; however, occasionally has some outlier of bad performance (to be explored)
- our `fit_mvt(nu = 6)` works much better than `fit_mvt()` (even is the passed `nu` is not correct) and the computational cost is half!

- `QRM::fit.mst()` has similar performance to our `fit_mvt()` (except that it fails with few observations), but the computational cost is unnacceptably high. It's not an option in practice.
- `MASS::cov.trov(nu = 6)` seems to be the best of the benchmarks with a slighlty worse performance than our `fit_mvt(nu = 6)` and with similar compulational cost.
- `MASS::cov.mve()` has a poor performance and unnacceptable computational cost.
- `MASS::cov.mcd()` has an acceptable performance but the computational cost is ridiculous (so not included anymore in the numerical comparisons).
- `robustbase::covMcd()` is better in performance and definitely in speed compared to its counterpart `MASS::cov.mcd()`.
- `robust::covRob()` has a reasonable performance with a low computational cost, but still our `fit_mvt(nu = 6)` is much better.



# Algorithm Description
The algorithms used in the package are based on the papers [@LiuRubin95], [@ZhouLiuKumarPalomar2019].

TBD



# References {-}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent
